<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User - ระบบยืมครุภัณฑ์</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/fonts.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Sarabun', 'Kanit', 'TH Sarabun New',
                         'Angsana New', 'Cordia New',
                         'Microsoft Sans Serif', sans-serif;
            background: #f0f2f5;
            padding: 20px;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { color: #667eea; font-family: 'Angsana New', sans-serif; }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
        }
        .btn-logout { background: #dc3545; color: white; }
        .btn-borrow { background: #28a745; color: white; }
        .btn-return { background: #ffc107; color: #333; }
        .content { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .stat-card h3 { font-size: 2em; color: #667eea; font-family: 'Angsana New', sans-serif; }
        .stat-card p { color: #666; }
        .stat-card.alert { background: #ffe6e6; border: 2px solid #dc3545; }
        .stat-card.alert h3 { color: #dc3545; }
        
        /* Overdue Alert */
        .overdue-alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        .overdue-alert h3 {
            color: #856404;
            margin-bottom: 10px;
            font-family: 'Angsana New', sans-serif;
        }
        .overdue-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        /* Search & Filter */
        .search-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .search-box {
            flex: 1;
            min-width: 200px;
            display: flex;
            gap: 10px;
        }
        .search-box input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
        }
        .filter-box select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #667eea; color: white; }
        
        .status-available { background: #d4edda; color: #155724; padding: 5px 10px; border-radius: 15px; font-size: 12px; }
        .status-borrowed { background: #fff3cd; color: #856404; padding: 5px 10px; border-radius: 15px; font-size: 12px; }
        
        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
        .tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-family: inherit;
        }
        .tab.active { background: #667eea; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 400px;
        }
        .modal-content h2 { margin-bottom: 20px; font-family: 'Angsana New', sans-serif; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-family: inherit; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;
        }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1><i class="fas fa-user"></i> User Dashboard</h1>
            <p id="userName">Loading...</p>
        </div>
        <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</button>
    </div>
    
    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3 id="totalAvailable">0</h3>
            <p>พร้อมยืม</p>
        </div>
        <div class="stat-card">
            <h3 id="myBorrows">0</h3>
            <p>กำลังยืม</p>
        </div>
        <div class="stat-card alert">
            <h3 id="myOverdue">0</h3>
            <p>เกินกำหนดคืน</p>
        </div>
    </div>
    
    <!-- Overdue Alert -->
    <div id="overdueAlert" class="overdue-alert">
        <h3><i class="fas fa-exclamation-triangle"></i> ครุภัณฑ์ที่เกินกำหนดคืน</h3>
        <div id="overdueList"></div>
    </div>
    
    <div class="content">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('equipment')">ครุภัณฑ์ที่ให้ยืม</button>
            <button class="tab" onclick="switchTab('history')">ประวัติการยืมของฉัน</button>
        </div>
        
        <!-- Tab: Equipment -->
        <div id="tab-equipment" class="tab-content active">
            <!-- Search & Filter -->
            <div class="search-filter">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ค้นหาครุภัณฑ์..." onkeyup="searchEquipment()">
                    <button onclick="searchEquipment()"><i class="fas fa-search"></i></button>
                </div>
                <div class="filter-box">
                    <select id="categoryFilter" onchange="filterEquipment()">
                        <option value="">ทุกหมวดหมู่</option>
                        <option value="คอมพิวเตอร์">คอมพิวเตอร์</option>
                        <option value="โน้ตบุ๊ค">โน้ตบุ๊ค</option>
                        <option value="เคส">เคส</option>
                        <option value="เก้าอี้">เก้าอี้</option>
                        <option value="โต๊ะ">โต๊ะ</option>
                        <option value="เมาส์">เมาส์</option>
                        <option value="คีย์บอร์ด">คีย์บอร์ด</option>
                        <option value="จอภาพ">จอภาพ</option>
                        <option value="เครื่องพิมพ์">เครื่องพิมพ์</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>
                </div>
                <div class="filter-box">
                    <select id="statusFilter" onchange="filterEquipment()">
                        <option value="">ทุกสถานะ</option>
                        <option value="พร้อมใช้งาน">พร้อมใช้งาน</option>
                        <option value="ถูกยืม">ถูกยืม</option>
                    </select>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>รูป</th>
                        <th>รหัส</th>
                        <th>ชื่อ</th>
                        <th>หมวดหมู่</th>
                        <th>ยี่ห้อ</th>
                        <th>สถานที่</th>
                        <th>สถานะ</th>
                        <th>ดำเนินการ</th>
                    </tr>
                </thead>
                <tbody id="equipmentTable"></tbody>
            </table>
        </div>
        
        <!-- Tab: History -->
        <div id="tab-history" class="tab-content">
            <table>
                <thead>
                    <tr>
                        <th>รหัสการยืม</th>
                        <th>ครุภัณฑ์</th>
                        <th>วันที่ยืม</th>
                        <th>กำหนดคืน</th>
                        <th>วันที่คืนจริง</th>
                        <th>สถานะ</th>
                    </tr>
                </thead>
                <tbody id="historyTable"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal ยืมครุภัณฑ์ -->
    <div id="borrowModal" class="modal">
        <div class="modal-content">
            <h2>ยืมครุภัณฑ์</h2>
            <form id="borrowForm">
                <input type="hidden" id="borrowEquipmentId">
                <div class="form-group">
                    <label>วัตถุประสงค์การยืม</label>
                    <textarea id="borrowPurpose" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>วันที่ต้องการคืน</label>
                    <input type="date" id="borrowReturnDate" required>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-borrow">ยืนยันการยืม</button>
                    <button type="button" onclick="closeModal()" style="background: #6c757d; color: white;">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal คืนครุภัณฑ์ -->
    <div id="returnModal" class="modal">
        <div class="modal-content">
            <h2>คืนครุภัณฑ์</h2>
            <form id="returnForm">
                <input type="hidden" id="returnEquipmentId">
                <div class="form-group">
                    <label>สภาพครุภัณฑ์เมื่อคืน</label>
                    <select id="returnCondition" required>
                        <option value="ดี">ดี</option>
                        <option value="ชำรุดเล็กน้อย">ชำรุดเล็กน้อย</option>
                        <option value="ชำรุด">ชำรุด</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>หมายเหตุ</label>
                    <textarea id="returnNotes" rows="3"></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-return">ยืนยันการคืน</button>
                    <button type="button" onclick="closeModal()" style="background: #6c757d; color: white;">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:5000/api';
        let currentUserId = null;
        
        async function checkAuth() {
            const res = await fetch(`${API_URL}/check-auth`, {credentials: 'include'});
            const data = await res.json();
            if (!data.authenticated) {
                window.location.href = 'login.html';
                return false;
            }
            currentUserId = data.user.id;
            document.getElementById('userName').textContent = data.user.full_name;
            return true;
        }
        
        async function loadStats() {
            // นับครุภัณฑ์พร้อมยืม
            const eqRes = await fetch(`${API_URL}/equipment`, {credentials: 'include'});
            const equipment = await eqRes.json();
            document.getElementById('totalAvailable').textContent = equipment.filter(e => e.status === 'พร้อมใช้งาน').length;
            
            // นับรายการที่กำลังยืม
            const histRes = await fetch(`${API_URL}/borrow-history`, {credentials: 'include'});
            const history = await histRes.json();
            const myBorrows = history.filter(h => h.status === 'กำลังยืม');
            document.getElementById('myBorrows').textContent = myBorrows.length;
            
            // โหลดรายการเกินกำหนดคืน
            const overdueRes = await fetch(`${API_URL}/overdue`, {credentials: 'include'});
            const overdue = await overdueRes.json();
            document.getElementById('myOverdue').textContent = overdue.length;
            
            const overdueAlert = document.getElementById('overdueAlert');
            const overdueList = document.getElementById('overdueList');
            
            if (overdue.length > 0) {
                overdueAlert.style.display = 'block';
                overdueList.innerHTML = overdue.map(o => `
                    <div class="overdue-item">
                        <strong>${o.equipment_name}</strong> - กำหนดคืน: ${o.return_due_date}
                        <button class="btn-return" onclick="openReturnModal('${o.equipment_id}')" style="margin-left: 10px;">คืนเดี๋ยวนี้</button>
                    </div>
                `).join('');
            } else {
                overdueAlert.style.display = 'none';
            }
        }
        
        async function loadEquipment() {
            const res = await fetch(`${API_URL}/equipment`, {credentials: 'include'});
            const equipment = await res.json();
            renderEquipment(equipment);
        }
        
        async function loadCategories() {
            const res = await fetch(`${API_URL}/categories`, {credentials: 'include'});
            // Load categories - now using fixed dropdown
            // const categories = await res.json();
            // const select = document.getElementById('categoryFilter');
            // select.innerHTML = '<option value="">ทุกหมวดหมู่</option>' +
            //     categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        
        async function searchEquipment() {
            const query = document.getElementById('searchInput').value;
            const category = document.getElementById('categoryFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            let url = `${API_URL}/equipment/search?q=${encodeURIComponent(query)}`;
            if (category) url += `&category=${encodeURIComponent(category)}`;
            if (status) url += `&status=${encodeURIComponent(status)}`;
            
            const res = await fetch(url, {credentials: 'include'});
            const equipment = await res.json();
            renderEquipment(equipment);
        }
        
        function filterEquipment() {
            searchEquipment();
        }
        
        async function loadHistory() {
            const res = await fetch(`${API_URL}/borrow-history`, {credentials: 'include'});
            const history = await res.json();
            
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = history.map(h => `
                <tr>
                    <td>${h.id}</td>
                    <td>${h.equipment_name}</td>
                    <td>${h.borrow_date || '-'}</td>
                    <td>${h.return_due_date || '-'}</td>
                    <td>${h.actual_return_date || '-'}</td>
                    <td>${h.status}</td>
                </tr>
            `).join('');
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            if (tabName === 'equipment') loadEquipment();
            if (tabName === 'history') loadHistory();
        }
        
        function renderEquipment(equipment) {
            const tbody = document.getElementById('equipmentTable');
            tbody.innerHTML = equipment.map(eq => {
                let action = '';
                if (eq.status === 'พร้อมใช้งาน') {
                    action = `<button class="btn-borrow" onclick="openBorrowModal('${eq.id}')">ยืม</button>`;
                } else if (eq.status === 'ถูกยืม' && eq.borrower_id == currentUserId) {
                    action = `<button class="btn-return" onclick="openReturnModal('${eq.id}')">คืน</button>`;
                }
                
                const imageHtml = eq.image
                    ? `<img src="${eq.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">`
                    : `<span style="color: #999;">-</span>`;
                
                return `
                    <tr>
                        <td>${imageHtml}</td>
                        <td>${eq.id}</td>
                        <td>${eq.name}</td>
                        <td>${eq.category}</td>
                        <td>${eq.brand || '-'}</td>
                        <td>${eq.location || '-'}</td>
                        <td><span class="status-${eq.status === 'พร้อมใช้งาน' ? 'available' : 'borrowed'}">${eq.status}</span></td>
                        <td>${action}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function openBorrowModal(id) {
            document.getElementById('borrowEquipmentId').value = id;
            document.getElementById('borrowModal').style.display = 'flex';
        }
        
        function openReturnModal(id) {
            document.getElementById('returnEquipmentId').value = id;
            document.getElementById('returnModal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('borrowModal').style.display = 'none';
            document.getElementById('returnModal').style.display = 'none';
        }
        
        document.getElementById('borrowForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('borrowEquipmentId').value;
            const data = {
                equipment_id: id,
                purpose: document.getElementById('borrowPurpose').value,
                borrow_date: new Date().toISOString().split('T')[0],
                return_due_date: document.getElementById('borrowReturnDate').value
            };
            
            const res = await fetch(`${API_URL}/borrow`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                closeModal();
                loadEquipment();
                loadStats();
                alert('ยืมครุภัณฑ์สำเร็จ!');
            } else {
                const err = await res.json();
                alert(err.error || 'เกิดข้อผิดพลาด');
            }
        });
        
        document.getElementById('returnForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('returnEquipmentId').value;
            
            const data = {
                actual_return_date: new Date().toISOString().split('T')[0]
            };
            
            const res = await fetch(`${API_URL}/return-by-equipment/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                closeModal();
                loadEquipment();
                loadStats();
                alert('คืนครุภัณฑ์สำเร็จ!');
            } else {
                const err = await res.json();
                alert(err.error || 'เกิดข้อผิดพลาด');
            }
        });
        
        async function logout() {
            await fetch(`${API_URL}/logout`, {method: 'POST', credentials: 'include'});
            window.location.href = 'login.html';
        }
        
        window.onload = async () => {
            if (await checkAuth()) {
                loadCategories();
                loadEquipment();
                loadStats();
            }
        };
    </script>
</body>
</html>
